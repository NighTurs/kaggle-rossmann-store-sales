---
title: "Exploring rossmann store sales"
author: "NighTurs"
date: "November 5, 2015"
output: html_document
---

The website for this competition is https://www.kaggle.com/c/rossmann-store-sales

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(data.table)
library(plyr)
set.seed(294)
```

Read data

```{r warning=FALSE, message=FALSE}
train <- fread("data/train.csv", head = T, sep = ',')
stores <- fread("data/store.csv", head = T, sep = ',')
data <- merge(train, stores, by = "Store")
row_count <- nrow(data)
col_count <- ncol(data)
cat("Row count : ", row_count, "; Columns count : ", col_count)
```

First glance at columns and values

```{r warning=FALSE, message=FALSE}
str(data)
```

Crafting and transforming variables needed for all future analysis

```{r warning=FALSE, message=FALSE}
data$Open = factor(data$Open, levels = c(0, 1), labels = c("Closed", "Open"))
data$Promo = factor(data$Promo, levels = c(0, 1), labels = c("None", "Promo"))
data$StateHoliday = factor(data$StateHoliday, levels = c("0", "a", "b", "c"), labels = c("None", "Public", "Easter", "Christmas"))
data$SchoolHoliday = factor(data$SchoolHoliday, levels = c("0", "1"), labels = c("None", "Holiday"))
data$StoreType = factor(data$StoreType, levels = c("c", "a", "d", "b"), labels = c("C", "A", "D", "B"))
data$Assortment = factor(data$Assortment, levels = c("a", "c", "b"), labels = c("Basic", "Extended", "Extra"))
data$Promo2 = factor(data$Promo2, levels = c(0, 1), labels = c("None", "Promo"))
data$PromoInterval = factor(data$PromoInterval, levels = c("", "Jan,Apr,Jul,Oct", "Feb,May,Aug,Nov", "Mar,Jun,Sept,Dec"), labels = c("None", "Jan,Apr,Jul,Oct", "Feb,May,Aug,Nov", "Mar,Jun,Sept,Dec"))
data$Promo2SinceWeek[is.na(data$Promo2SinceWeek)] <- -1
data$Promo2SinceYear[is.na(data$Promo2SinceYear)] <- -1
data$CompetitionOpenSinceMonth[is.na(data$CompetitionOpenSinceMonth)] <- -1
data$CompetitionOpenSinceYear[is.na(data$CompetitionOpenSinceYear)] <- -1
data$CompetitionDistance[is.na(data$CompetitionDistance)] <- -1
data$Date = as.Date(data$Date)
data$DayOfYear = as.integer(format(data$Date, "%j"))
data$Year = as.integer(format(data$Date, "%Y"))
data$Week = as.integer(format(data$Date, "%U"))
data$Month = as.integer(format(data$Date, "%m"))
tmp <- paste(data$Promo2SinceYear, data$Promo2SinceWeek, rep("1", nrow(data)), sep = " ")
data$Promo2Date <- do.call(c, lapply(tmp, function(d) {as.Date(d, format = "%Y %U %u")}))
data$Promo2Days <- as.integer(difftime(data$Date, data$Promo2Date, units = "days"))
```

Are there still any NA's? (Promo2Date, Promo2Days are expected to have them)
```{r warning=FALSE, message=FALSE}
which(data[,colSums(is.na(data))>0])
```

Looking at Sales summaries
```{r warning=FALSE, message=FALSE}
summary(data$Sales)
summary(data[data$Open == "Closed", ]$Sales)
```

Lets remove all rows with store being closed, and also cap Sales by 20000
```{r warning=FALSE, message=FALSE}
data <- data[data$Open == "Open" & data$Sales <= 20000]
```

Plot sales
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(Sales) + geom_histogram(binwidth = 50, fill = "blue", alpha = 0.5)
```

Plot how promo affects sales
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(Promo, fill = Promo) + geom_bar()
ggplot(data) + aes(Sales, fill = Promo) + geom_histogram(binwidth = 50, position = "identity", alpha = 0.5)
```

Store types 
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(StoreType, fill = Assortment) + geom_bar()

ggplot(data) + aes(StoreType, Sales, fill = Assortment) + geom_boxplot(outlier.size = 1, outlier.colour = "blue")
```

Holidays
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
table(data$StateHoliday)
ggplot(data) + aes(StateHoliday, Sales, fill = StateHoliday) + geom_boxplot(outlier.size = 1, outlier.colour = "blue")

ggplot(data) + aes(SchoolHoliday, fill = SchoolHoliday) + geom_bar()
ggplot(data) + aes(SchoolHoliday, Sales, fill = SchoolHoliday) + geom_boxplot( outlier.size = 1, outlier.colour = "blue")
```

How school holidays are distributed throught weekdays?
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(as.factor(DayOfWeek), fill = SchoolHoliday) + geom_bar()
```

Lets check for seasonality patterns, first only 2014. Can observe almost perfect 2 weeks seasonality, expect some rare cases when this pattern gets interrupted at the end of first week. Vertical lines are start and end of test data for 2015 year.
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data[data$Year == 2014]) + aes(DayOfYear, Sales, group = Year, colour = as.factor(Year)) + stat_summary(fun.y = median, geom = "line") + geom_vline(xintercept = c(213, 260)) + stat_summary(fun.y = median, aes(colour = as.factor(DayOfWeek)), geom = "point", size = 3) + scale_colour_hue("clarity")
```

There is also seems to be a years pattern, although it is largelly spoiled by incomplete weekly pattern (sometimes it causes differencies between years as can be seen in august)
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(DayOfYear, Sales, group = Year, colour = as.factor(Year)) + stat_summary(fun.y = median, geom = "line") + geom_vline(xintercept = c(213, 260)) + stat_summary(fun.y = median, aes(colour = as.factor(DayOfWeek)), geom = "point", size = 3) + scale_colour_hue("clarity")
```

Also lets check sales distribution by weekdays, months and weeks
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(as.factor(DayOfWeek), fill = DayOfWeek) + geom_bar()
ggplot(data) + aes(as.factor(DayOfWeek), Sales, fill = DayOfWeek) + geom_boxplot( outlier.size = 1, outlier.colour = "blue")
ggplot(data) + aes(as.factor(Week), Sales, fill = as.factor(Week)) + geom_boxplot( outlier.size = 1, outlier.colour = "blue")
ggplot(data) + aes(as.factor(Month), Sales, fill = as.factor(Month)) + geom_boxplot( outlier.size = 1, outlier.colour = "blue")
```

How does consequitive promo affects sales?
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data) + aes(PromoInterval, fill = PromoInterval) + geom_bar()
ggplot(data) + aes(PromoInterval, Sales, fill = PromoInterval) + geom_boxplot( outlier.size = 1, outlier.colour = "blue")
ggplot(data[!is.na(data$Promo2Date)]) + aes(Promo2Days, Sales, group = round_any(Promo2Days, 100), fill = round_any(Promo2Days, 100)) + geom_boxplot( outlier.size = 1, outlier.colour = "blue")
```

How does competition affects sales? Seems like competitions is good (of course it can be biased by some confounding variables)
```{r warning=FALSE, message=FALSE,  fig.width = 10, fig.height = 5}
ggplot(data[data$CompetitionDistance > -1 & data$CompetitionDistance < 35000]) + aes(CompetitionDistance, Sales, group = round_any(CompetitionDistance, 1000), fill = round_any(CompetitionDistance, 1000)) + geom_boxplot(outlier.size = 1, outlier.colour = "blue")
ggplot(data) + aes(CompetitionDistance > -1, Sales, fill = CompetitionDistance > -1) + geom_boxplot(outlier.size = 1, outlier.colour = "blue")
```

Are there any stores that got competitor during our observation period?
```{r warning=FALSE, message=FALSE}
which(data[, length(unique(CompetitionDistance)), by = Store][,1] > 1)
```
